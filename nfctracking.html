<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple SPA - NFC Tracking Data</title>
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.0/js/adal.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        button {
            padding: 10px 20px;
            margin: 20px 10px;
            border: none;
            background-color: #0078d7;
            color: white;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

            button:hover {
                background-color: #005a9e;
            }

        #message, #errorMessage {
            font-size: 16px;
            margin: 10px 0;
        }

        #message {
            color: green;
        }

        #errorMessage {
            color: red;
        }

        table {
            width: 90%;
            max-width: 1000px;
            margin-top: 20px;
            border-collapse: collapse;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            background-color: white;
        }

        th, td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: #0078d7;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        td {
            font-size: 16px;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #e0e0e0;
        }

        caption {
            font-size: 20px;
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <button id="login">Login</button>
    <button id="logout" style="display:none;">Logout</button>
    <button id="getNFCTrackingData" style="display:none;">NFC Tracking Data</button>

    <div id="errorMessage"></div>
    <div id="message"></div>

    <table id="nfctrackingsTable" style="display:none;">
        <caption>NFC Tracking Data</caption>
        <thead>
            <tr>
                <th>Name</th>
                <th>Tag ID</th>
                <th>Status</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody id="nfctrackingsTableBody"></tbody>
    </table>

    <script type="text/javascript">
        "use strict";

        //Set these variables to match your environment
        var organizationURI = "https://izenixlearn.api.crm.dynamics.com"; //The URL to connect to CRM (online)
        var tenant = "izenixlearn.onmicrosoft.com"; //Azure AD organization
        var clientId = "78d9abf2-52c4-4f68-a69d-dfab8a564eab"; //ClientId from application registration
        var pageUrl = "https://www.izenix.com/nfctracking.html"; //URL of this page in your environment

        var user, authContext, message, errorMessage, loginButton, logoutButton, getNFCTrackingDataButton, nfctrackingsTable, nfctrackingsTableBody;

        //Configuration data for AuthenticationContext
        var endpoints = {
            orgUri: organizationURI
        };

        window.config = {
            tenant: tenant,
            clientId: clientId,
            postLogoutRedirectUri: pageUrl,
            endpoints: endpoints,
            cacheLocation: 'localStorage',
        };

        document.onreadystatechange = function () {
            if (document.readyState == "complete") {

                //Set DOM elements referenced by scripts
                message = document.getElementById("message");
                errorMessage = document.getElementById("errorMessage");
                loginButton = document.getElementById("login");
                logoutButton = document.getElementById("logout");
                getNFCTrackingDataButton = document.getElementById("getNFCTrackingData");
                nfctrackingsTable = document.getElementById("nfctrackingsTable");
                nfctrackingsTableBody = document.getElementById("nfctrackingsTableBody");

                //Event handlers on DOM elements
                loginButton.addEventListener("click", login);
                logoutButton.addEventListener("click", logout);
                getNFCTrackingDataButton.addEventListener("click", getNFCTrackingData);

                authenticate();

                if (user) {
                    loginButton.style.display = "none";
                    logoutButton.style.display = "block";
                    getNFCTrackingDataButton.style.display = "block";

                    var helloMessage = document.createElement("p");
                    helloMessage.textContent = "Hello " + user.profile.name;
                    message.appendChild(helloMessage);
                } else {
                    loginButton.style.display = "block";
                    logoutButton.style.display = "none";
                    getNFCTrackingDataButton.style.display = "none";
                }
            }
        };

        // Authentication
        function authenticate() {
            authContext = new AuthenticationContext(config);

            var isCallback = authContext.isCallback(window.location.hash);
            if (isCallback) {
                authContext.handleWindowCallback();
            }
            var loginError = authContext.getLoginError();
            if (isCallback && !loginError) {
                window.location = authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST);
            } else {
                errorMessage.textContent = loginError;
            }
            user = authContext.getCachedUser();
        }

        function login() {
            authContext.login();
        }

        function logout() {
            authContext.logOut();
            nfctrackingsTable.style.display = "none";
            nfctrackingsTableBody.innerHTML = "";
        }

        function getNFCTrackingData() {
            getNFCTrackingDataButton.disabled = true;
            var retrievingMessage = document.createElement("p");
            retrievingMessage.textContent = "Retrieving NFC tracking data...";
            message.appendChild(retrievingMessage);

            authContext.acquireToken(organizationURI, retrieveNFCTrackingData);
        }

        function retrieveNFCTrackingData(error, token) {
            if (error || !token) {
                errorMessage.textContent = 'ADAL error occurred: ' + error;
                return;
            }

            var req = new XMLHttpRequest();
            req.open("GET", encodeURI(organizationURI + "/api/data/v9.2/izx_nfctrackings?$select=izx_name,izx_tagid,izx_status,izx_timestamp"), true);
            req.setRequestHeader("Authorization", "Bearer " + token);
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            req.setRequestHeader("OData-MaxVersion", "4.0");
            req.setRequestHeader("OData-Version", "4.0");

            req.onreadystatechange = function () {
                if (this.readyState == 4) {
                    req.onreadystatechange = null;
                    if (this.status == 200) {
                        var nfctrackings = JSON.parse(this.response).value;
                        renderNFCTrackingData(nfctrackings);
                    } else {
                        var error = JSON.parse(this.response).error;
                        console.log(error.message);
                        errorMessage.textContent = error.message;
                    }
                }
            };
            req.send();
        }

        function renderNFCTrackingData(nfctrackings) {
            nfctrackings.forEach(function (tracking) {
                var nameCell = document.createElement("td");
                nameCell.textContent = tracking.izx_name;

                var tagIdCell = document.createElement("td");
                tagIdCell.textContent = tracking.izx_tagid;

                var statusCell = document.createElement("td");
                statusCell.textContent = tracking.izx_status;

                var timestampCell = document.createElement("td");
                timestampCell.textContent = tracking.izx_timestamp;

                var row = document.createElement("tr");
                row.appendChild(nameCell);
                row.appendChild(tagIdCell);
                row.appendChild(statusCell);
                row.appendChild(timestampCell);

                nfctrackingsTableBody.appendChild(row);
            });

            nfctrackingsTable.style.display = "block";
        }
    </script>
</body>
</html>
