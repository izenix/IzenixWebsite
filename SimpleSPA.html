<!--<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Tracking and Users</title>

    <style>
        /* General Styling */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }

        h1, h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 15px;
        }

        #nfcTrackingSection, #usersSection {
            background-color: white;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Flexbox Layout for Buttons */
        .container {
            display: flex;
            justify-content: space-between; /* Space between left and right buttons */
            align-items: center;
            margin-bottom: 20px;
        }

        /* Button Styling */
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

            button:hover {
                background-color: #45a049;
                transform: translateY(-2px);
            }

            button:disabled {
                background-color: #ddd;
                cursor: not-allowed;
            }

        #showNFCButton, #showUsersButton {
            background-color: #007bff;
        }

            #showNFCButton:hover, #showUsersButton:hover {
                background-color: #0056b3;
            }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

            table caption {
                font-size: 20px;
                font-weight: bold;
                margin-bottom: 10px;
                text-align: left;
            }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
            font-size: 16px;
            color: #555;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        td {
            font-size: 14px;
            color: #333;
        }

        /* Hidden class to toggle visibility */
        .hidden {
            display: none;
        }

        /* Styling for NFC and Users buttons on the left side */
        .nfc-users-buttons {
            display: flex;
            flex-direction: column;
        }

            .nfc-users-buttons button {
                width: 220px;
                padding: 12px;
                font-size: 16px;
                background-color: #28a745;
            }

                .nfc-users-buttons button:hover {
                    background-color: #218838;
                }

        /* Styling for Login and Logout buttons on the right side */
        .auth-buttons {
            display: flex;
            flex-direction: row;
        }

            .auth-buttons button {
                width: 120px;
                padding: 10px;
                font-size: 16px;
                background-color: #007bff;
            }

                .auth-buttons button:hover {
                    background-color: #0056b3;
                }

        /* Show Button Styling */
        #tagIdButton {
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            font-size: 16px;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

            #tagIdButton:hover {
                background-color: #45a049;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
                transform: translateY(-5px);
            }

            #tagIdButton:focus {
                outline: none;
                box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.5);
            }

        /* Message & Error Styling */
        #message, #userMessage {
            margin-top: 10px;
            color: #4CAF50;
            font-weight: bold;
        }

        #errorMessage, #userErrorMessage {
            color: red;
            margin-top: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                align-items: center;
            }

            .nfc-users-buttons button, .auth-buttons button {
                width: 100%;
                max-width: 300px;
            }
        }

        /* The Modal (background) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }

        /* Modal Content/Box */
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        /* The Close Button */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

        #errorMessage {
            color: red;
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }
        #greetingMessage {
            font-family: 'Arial', sans-serif;
            font-size: 10px;
            color: #333;
            background-color: #f9f9f9;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin: 10px 0;
            display: inline-block;
        }

         /* Container for the button and search bar */
        #nfcTrackingContainer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px;
        }

        /* Style for the NFC Tracking Data button */
        #getNFCTrackingData {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            cursor: pointer;
        }

            #getNFCTrackingData:hover {
                background-color: #218838;
            }

       /* Style for the search bar*/
        #searchBar {
            padding: 10px;
            font-size: 16px;
            width: 250px;
            border-radius: 5px;
            border: 1px solid #ccc;
            display: none;
            /*Initially: hidden;*/
        }

        #searchBar.active {
            display: block;

        }

        /* Styling for NFC and Users buttons on the left side */
        .nfc-users-buttons {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }

            .nfc-users-buttons button {
                width: 220px;
                padding: 12px;
                font-size: 16px;
                background-color: #28a745;
            }

                .nfc-users-buttons button:hover {
                    background-color: #218838;
                }

        /* Responsive design: Stack buttons vertically on smaller screens */
        @media (max-width: 768px) {
            .nfc-users-buttons {
                flex-direction: column;
                align-items: center;
            }

                .nfc-users-buttons button {
                    width: 100%;
                    max-width: 300px;
                }
        }


        /*Cange CSS*/
        /* General Menu Styling */
        .nfc-menu {
            position: relative;
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 40px;
            left: 0;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            padding: 10px;
        }

            .menu-dropdown button {
                display: block;
                width: 200px;
                padding: 10px;
                background-color: #28a745;
                color: white;
                border: none;
                cursor: pointer;
                margin: 5px 0;
            }

                .menu-dropdown button:hover {
                    background-color: #218838;
                }

        /* Show menu on hover */
        .nfc-menu:hover .menu-dropdown {
            display: block;
        }

        /* Hide and show sections based on selection */
        .hidden {
            display: none;
        }


    </style>

    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.17/js/adal.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.29.0/js/msal-browser.min.js"></script>

</head>
<body>-->
<!-- NFC Menu and Buttons -->
<!--<div class="container">
    <div class="nfc-menu">
        <button id="menuButton">NFC Menu</button>
        <div class="menu-dropdown hidden">
            <button id="showNFCButton">NFC Tracking Data</button>
            <button id="showUsersButton">Users</button>
            <button id="showMonthWiseDataButton">Month Wise Data</button>
        </div>
    </div>-->
<!-- Authentication buttons -->
<!--<div class="auth-buttons">
        <button id="login">Login</button>
        <button id="logout" class="hidden">Logout</button>
        <span id="greetingMessage"></span>
    </div>
</div>-->
<!-- NFC Tracking Data Section -->
<!--<div id="nfcTrackingSection">
    <div id="nfcTrackingContainer">
        <button id="getNFCTrackingData">NFC Tracking Data</button>
        <input type="text" id="searchBar"  placeholder="Search by Tag ID...">
    </div>
    <div id="message"></div>
    <table id="nfctrackingsTable">
        <caption>NFC Tracking Data</caption>
        <thead>
            <tr>
                <th>Name</th>
                <th>Tag ID</th>
                <th>Timestamp</th>
                <th>Time In</th>
                <th>Time Out</th>
                <th>Time Duration</th>
                <th>Time In Out</th>
            </tr>
        </thead>
        <tbody id="nfctrackingsTableBody"></tbody>
    </table>
</div>-->
<!-- Get Users Section -->
<!--<div id="usersSection">
    <h1>Get Users from Dynamics 365</h1>
    <div id="userErrorMessage" style="color: red;"></div>
    <button id="getUsers">Get Users</button>
    <table id="usersTable">
        <thead>
            <tr>
                <th>TagID</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Phone Number</th>
                <th>NFC Counter</th>
                <th>-</th>
            </tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
    </table>
</div>-->
<!-- Modal Structure -->
<!--<div id="tagDetailsModal" class="modal hidden">
    <div class="modal-content">
        <div id="userMessage"></div>
        <span class="close">&times;</span>
        <h2>Tag Details</h2>
        <table>
            <thead>
                <tr>
                    <th>Tag ID</th>
                    <th>Timestamp</th>
                    <th>Time IN</th>
                    <th>Time Out</th>
                    <th>Duration</th>
                    <th>In/Out</th>
                </tr>
            </thead>
            <tbody id="modalTagDetailsTableBody"></tbody>
        </table>
    </div>
</div>-->
<!-- Month Wise Data Section -->
<!--<div id="monthSection" class="hidden">
        <h2>Fetch Month-wise NFC Tracking Data</h2>
        <label for="monthYearInput">Select Month and Year: </label>
        <input type="month" id="monthYearInput" required>
        <br><br>
        <button id="monthData">Get Data</button>
        <p id="monthMessage"></p>
        <table id="monthwisetable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Tag ID</th>
                    <th>Timestamp</th>
                    <th>Time In</th>
                    <th>Time Out</th>
                    <th>Duration</th>
                    <th>In/Out</th>
                </tr>
            </thead>
            <tbody id="monthwisetableBody"></tbody>
        </table>
    </div>




    <script type="text/javascript">
        "use strict";

        document.addEventListener('DOMContentLoaded', function () {
            // Buttons
            const loginButton = document.getElementById('login');
            const logoutButton = document.getElementById('logout');
            const nfcButton = document.getElementById('showNFCButton');
            const usersButton = document.getElementById('showUsersButton');
            const monthButton = document.getElementById('showMonthWiseDataButton');

            // Sections
            const nfcSection = document.getElementById('nfcTrackingSection');
            const usersSection = document.getElementById('usersSection');
            const monthSection = document.getElementById('monthSection');

            // Error Message
            const errorMessage = document.getElementById('errorMessage');

            // User placeholder (to be replaced by actual authentication)
            let authContext, user, loginButton, logoutButton, userLoginButton, userLogoutButton, getUsersButton, usersTable, getNFCTrackingDataButton, searchBar, nfctrackingsTable, nfctrackingsTableBody, usersTableBody, getMonthButton, monthwisetable, monthwisetableBody, message, errorMessage;

            // Initialize authentication context and check user status
            authenticate();

            // Check if the user is already logged in
            if (user) {
                showUserUI();
            } else {
                showGuestUI();
            }

            // Hide all sections initially
            function hideAllSections() {
                nfcSection.classList.add('hidden');
                usersSection.classList.add('hidden');
                monthSection.classList.add('hidden');
            }

            // Show section buttons after login
            function enableAllButtons() {
                nfcButton.classList.remove('hidden');
                usersButton.classList.remove('hidden');
                monthButton.classList.remove('hidden');
            }

            // Hide section buttons after logout
            function disableAllButtons() {
                nfcButton.classList.add('hidden');
                usersButton.classList.add('hidden');
                monthButton.classList.add('hidden');
            }

            // NFC Button Click Event
            nfcButton.addEventListener('click', function () {
                hideAllSections();
                nfcSection.classList.remove('hidden');
            });

            // Users Button Click Event
            usersButton.addEventListener('click', function () {
                hideAllSections();
                usersSection.classList.remove('hidden');
            });

            // Month Wise Data Button Click Event
            monthButton.addEventListener('click', function () {
                hideAllSections();
                monthSection.classList.remove('hidden');
            });

            // Login Button Click Event
            loginButton.addEventListener('click', function () {
                login();  // Call the login function to authenticate
            });

            // Logout Button Click Event
            logoutButton.addEventListener('click', function () {
                logout();  // Call the logout function to log out the user
            });

            // UI functions to handle user states
            function showUserUI() {
                loginButton.classList.add('hidden');
                logoutButton.classList.remove('hidden');
                enableAllButtons();

                // Show welcome message with user's name
                document.getElementById('greetingMessage').textContent = 'Welcome!';
                const greetingContainer = document.getElementById("greetingMessage");
                const helloMessage = document.createElement("span");
                helloMessage.textContent = "Hello, " + user.profile.name;
                greetingContainer.appendChild(helloMessage);
            }

            function showGuestUI() {
                logoutButton.classList.add('hidden');
                loginButton.classList.remove('hidden');
                disableAllButtons();
                hideAllSections();
                document.getElementById('greetingMessage').textContent = '';  // Clear greeting message
            }

            // Initial UI state
            disableAllButtons();
            hideAllSections();
        });

        // Function to authenticate the user
        function authenticate() {
            try {
                authContext = new AuthenticationContext(config);
                const isCallback = authContext.isCallback(window.location.hash);
                if (isCallback) {
                    authContext.handleWindowCallback();
                }
                const loginError = authContext.getLoginError();
                if (isCallback && !loginError) {
                    window.location = authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST);
                } else if (loginError) {
                    errorMessage.textContent = loginError;
                }

                // Cache the logged-in user
                user = authContext.getCachedUser();

            } catch (e) {
                console.error("Authentication error:", e);
                errorMessage.textContent = "Authentication initialization failed.";
            }
        }

        // Login function
        function login() {
            try {
                authContext.login();  // Initiates the authentication process
            } catch (e) {
                console.error("Login error:", e);
                errorMessage.textContent = "Login failed.";
            }
        }

        // Logout function
        function logout() {
            try {
                authContext.logOut();  // Logs out the user and clears the session
                showGuestUI();  // Update the UI to guest state
            } catch (e) {
                console.error("Logout error:", e);
                errorMessage.textContent = "Logout failed.";
            }
        }








        // Your existing NFC Tracking Data and Get Users code goes here
        var organizationURI = "https://izenixlearn.api.crm.dynamics.com";      // CRM URL
        var tenant = "izenixlearn.onmicrosoft.com";                            // Azure AD tenant
        var clientId = "78d9abf2-52c4-4f68-a69d-dfab8a564eab";                 // Client ID from Azure app registration
        var pageUrl = "https://www.izenix.com/SimpleSPA.html";                 // Redirect URL

        var authContext, user, loginButton, logoutButton, userLoginButton, userLogoutButton, getUsersButton, usersTable, getNFCTrackingDataButton, searchBar, nfctrackingsTable, nfctrackingsTableBody, usersTableBody, getMonthButton, monthwisetable, monthwisetableBody, message, errorMessage;

        // ADAL configuration
        var endpoints = {
            orgUri: organizationURI
        };

        window.config = {
            tenant: tenant,
            clientId: clientId,
            postLogoutRedirectUri: pageUrl,
            endpoints: endpoints,
            cacheLocation: 'localStorage' // Store tokens in localStorage
        };

        document.onreadystatechange = function () {
            if (document.readyState === "complete") {
                // Get references to the necessary DOM elements
                message = document.getElementById("message");
                errorMessage = document.getElementById("errorMessage");

                // Login and Logout buttons
                loginButton = document.getElementById("login");
                logoutButton = document.getElementById("logout");

                // NFC Tracking Data elements
                getNFCTrackingDataButton = document.getElementById("getNFCTrackingData");
                searchBar = document.getElementById("searchBar");
                nfctrackingsTable = document.getElementById("nfctrackingsTable");
                nfctrackingsTableBody = document.getElementById("nfctrackingsTableBody");

                // Users-related elements
                getUsersButton = document.getElementById("getUsers");
                usersTable = document.getElementById("usersTable");
                usersTableBody = document.getElementById("usersTableBody");

                // Month Wise Data elements
                getMonthButton = document.getElementById("monthData");
                monthwisetable = document.getElementById("monthwisetable");
                monthwisetableBody = document.getElementById("monthwisetableBody");



                // Add event listeners for NFC login/logout
                loginButton.addEventListener("click", login);
                logoutButton.addEventListener("click", logout);

                // Add event listeners for data retrieval and search
                getNFCTrackingDataButton.addEventListener("click", getNFCTrackingData);
                getUsersButton.addEventListener("click", getUsers);
                getMonthButton.addEventListener("click", monthData);

                // Add event listener for search functionality
                searchBar.addEventListener("input", searchByTagID);

                // Display greeting message to the logged-in user
                var greetingContainer = document.getElementById("greetingMessage");
                var helloMessage = document.createElement("span");
                helloMessage.textContent = "Hello " + user.profile.name;
                greetingContainer.appendChild(helloMessage);

                // Optionally, style the message if needed
                helloMessage.style.marginLeft = "10px";
                helloMessage.style.fontWeight = "bold";

                authenticate();




            }
        };

        // Function to authenticate the user
        function authenticate() {
            try {
                authContext = new AuthenticationContext(config);
                var isCallback = authContext.isCallback(window.location.hash);
                if (isCallback) {
                    authContext.handleWindowCallback();
                }
                var loginError = authContext.getLoginError();
                if (isCallback && !loginError) {
                    window.location = authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST);
                } else if (loginError) {
                    errorMessage.textContent = loginError;
                }

                user = authContext.getCachedUser();
            } catch (e) {
                console.error("Authentication error:", e);
                errorMessage.textContent = "Authentication initialization failed.";
            }
        }

        // Login function
        function login() {
            try {
                authContext.login();
            } catch (e) {
                console.error("Login error:", e);
                errorMessage.textContent = "Login failed.";
            }
        }

        // Logout function
        function logout() {
            authContext.logOut();
            usersTable.style.display = "none";
            usersTableBody.innerHTML = "";
        }

        // Function to get users
        function getUsers() {
            getUsersButton.disabled = true;
            message.textContent = "Retrieving users...";
            authContext.acquireToken(organizationURI, retrieveUsers);
        }

        // Function to retrieve users
        function retrieveUsers(error, token) {
            if (error || !token) {
                console.error("Token error:", error);
                errorMessage.textContent = 'ADAL error occurred: ' + error;
                return;
            }

            var req = new XMLHttpRequest();
            req.open("GET", encodeURI(organizationURI + "/api/data/v9.2/contacts?$select=fullname,emailaddress1,mobilephone,izx_tagid,izx_nfccounter&$filter=izx_tagid ne null"), true);
            req.setRequestHeader("Authorization", "Bearer " + token);
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            req.setRequestHeader("OData-MaxVersion", "4.0");
            req.setRequestHeader("OData-Version", "4.0");

            req.onreadystatechange = function () {
                if (this.readyState === 4) {
                    req.onreadystatechange = null;
                    if (this.status === 200) {
                        var users = JSON.parse(this.response).value;
                        renderUsers(users);
                    } else {
                        var error = JSON.parse(this.response).error;
                        console.error("Error retrieving users:", error.message);
                        errorMessage.textContent = error.message;
                    }
                }
            };
            req.send();
        }

        // Function to render users into the table
        function renderUsers(users) {
            usersTableBody.innerHTML = ''; // Clear previous results
            users.forEach(function (user) {
                var row = document.createElement("tr");

                var tagId = document.createElement("td");
                tagId.textContent = user.izx_tagid;

                var nameCell = document.createElement("td");
                nameCell.textContent = user.fullname;

                var emailCell = document.createElement("td");
                emailCell.textContent = user.emailaddress1;

                var mobilePhone = document.createElement("td");
                mobilePhone.textContent = user.mobilephone;

                var nfcCounterCell = document.createElement("tb");
                nfcCounterCell.textContent = user.izx_nfccounter;

                var tagIdCell = document.createElement("td");
                var tagIdButton = document.createElement("button");
                tagIdButton.textContent = "Show";
                tagIdButton.addEventListener("click", function () {
                    showTagIdData(user.izx_tagid); // Call function to show data user.izx_tagid
                });
                tagIdCell.appendChild(tagIdButton);

                row.appendChild(tagId);
                row.appendChild(nameCell);
                row.appendChild(emailCell);
                row.appendChild(mobilePhone);
                row.appendChild(nfcCounterCell);
                row.appendChild(tagIdCell);
                usersTableBody.appendChild(row);
            });
            usersTable.style.display = 'table';
            getUsersButton.disabled = false;
            message.textContent = '';
        }

        function showTagIdData(tagId) {
            debugger;
            authContext.acquireToken(organizationURI, function (error, token) {
                if (error || !token) {
                    console.error("Token error:", error);
                    errorMessage.textContent = 'ADAL error occurred: ' + error;
                    return;
                }

                var req = new XMLHttpRequest();
                // Ensure proper concatenation of $select and $filter
                var filterQuery = `$filter=izx_tagid eq '${tagId}'`;
                var selectQuery = `$select=izx_tagid,izx_timein,izx_timeout,izx_duration,izx_in_out,izx_timestamp`;
                var apiUrl = encodeURI(organizationURI + "/api/data/v9.2/izx_nfctrackings?" + selectQuery + "&" + filterQuery);
                req.open("GET", apiUrl, true);
                req.setRequestHeader("Authorization", "Bearer " + token);
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");

                req.onreadystatechange = function () {
                    if (this.readyState === 4) {
                        req.onreadystatechange = null;
                        if (this.status === 200) {
                            var tagDetails = JSON.parse(this.response).value;

                            // Check if records were returned for the tagId
                            if (tagDetails.length > 0) {
                                // Clear any existing rows in the modal table
                                var modalTableBody = document.getElementById("modalTagDetailsTableBody");
                                modalTableBody.innerHTML = "";

                                // Loop through each record and append it to the modal table
                                tagDetails.forEach(function (record) {
                                    var row = document.createElement("tr");

                                    // Helper function to format date (YYYY-MM-DD)
                                    function formatDate(dateString) {
                                        // Check if dateString is valid
                                        if (!dateString) {
                                            return 'N/A';
                                        }

                                        var date = new Date(dateString);
                                        // Check if the date is valid
                                        if (isNaN(date.getTime())) {
                                            return 'Invalid Date';
                                        }
                                        return date.toISOString().split('T')[0]; // Returns 'YYYY-MM-DD'
                                    }

                                    // Helper function to format time (HH:MM:SS)
                                    function formatTime(dateString) {
                                        // Check if dateString is valid
                                        if (!dateString) {
                                            return 'N/A';
                                        }

                                        var date = new Date(dateString);
                                        // Check if the date is valid
                                        if (isNaN(date.getTime())) {
                                            return 'Invalid Time';
                                        }
                                        return date.toISOString().split('T')[1].split('Z')[0]; // Returns 'HH:MM:SS'
                                    }

                                    // Create and append table cells for each field
                                    var tagIdCell = document.createElement("td");
                                    tagIdCell.textContent = record.izx_tagid || 'N/A';
                                    row.appendChild(tagIdCell);

                                    var timestampCell = document.createElement("td");
                                    timestampCell.textContent = formatDate(record.izx_timestamp) || 'N/A';
                                    row.appendChild(timestampCell);

                                    var timeInCell = document.createElement("td");
                                    timeInCell.textContent = formatTime(record.izx_timein) || 'N/A';
                                    row.appendChild(timeInCell);

                                    var timeOut = document.createElement("td");
                                    timeOut.textContent = formatTime(record.izx_timeout) || 'N/A';
                                    row.appendChild(timeOut);

                                    var durationCell = document.createElement("td");
                                    durationCell.textContent = record.izx_duration || 'N/A';
                                    row.appendChild(durationCell);

                                    var inOutCell = document.createElement("td");
                                    inOutCell.textContent = record.izx_in_out || 'N/A';
                                    row.appendChild(inOutCell);

                                    // Append the row to the modal table body
                                    modalTableBody.appendChild(row);
                                });

                                // Open the modal to display the data
                                var modal = document.getElementById("tagDetailsModal");
                                modal.style.display = "block";

                            } else {
                                alert("No records found for the provided tag ID.");
                                //console.error("No records found for the provided tag ID.");
                                //errorMessage.textContent = 'No records found for the provided tag ID.';
                            }
                        } else {
                            var error = JSON.parse(this.response).error;
                            console.error("Error retrieving tag details:", error.message);
                            errorMessage.textContent = error.message;
                        }
                    }
                };
                req.send();
            });
        }

        // When the user clicks on the close button, close the modal
        var closeModal = document.querySelector(".close");
        closeModal.onclick = function () {
            var modal = document.getElementById("tagDetailsModal");
            modal.style.display = "none";
        };

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            var modal = document.getElementById("tagDetailsModal");
            if (event.target === modal) {
                modal.style.display = "none";
            }
        };


        // Existing NFC Tracking Data code goes here
        var user, authContext, message, errorMessage, loginButton, logoutButton, getNFCTrackingDataButton, searchBar, nfctrackingsTable, nfctrackingsTableBody;

        var endpoints = { orgUri: organizationURI };

        window.config = {
            tenant: tenant,
            clientId: clientId,
            postLogoutRedirectUri: pageUrl,
            endpoints: endpoints,
            cacheLocation: 'localStorage',
        };

        function login() {
            authContext.login();
        }

        function logout() {
            authContext.logOut();
            nfctrackingsTableBody.innerHTML = "";
            nfctrackingsTable.style.display = "none";
            toggleLoggedInState(false);
        }

        function getNFCTrackingData() {
            getNFCTrackingDataButton.disabled = false;
            message.textContent = "Retrieving NFC tracking data...";
            authContext.acquireToken(organizationURI, retrieveNFCTrackingData);
        }

        function retrieveNFCTrackingData(error, token) {
            if (error || !token) {
                errorMessage.textContent = 'ADAL error occurred: ' + error;
                return;
            }

            var req = new XMLHttpRequest();
            req.open("GET", encodeURI(organizationURI + "/api/data/v9.2/izx_nfctrackings?$select=izx_name,izx_tagid,izx_status,izx_timestamp,izx_timein,izx_timeout,izx_duration,izx_in_out"), true);
            req.setRequestHeader("Authorization", "Bearer " + token);
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Content-Type", "application/json; charset=utf-8");

            req.onreadystatechange = function () {
                if (this.readyState === 4) {
                    if (this.status === 200) {
                        var nfctrackings = JSON.parse(this.response).value;
                        renderNFCTrackingData(nfctrackings);
                    } else {
                        errorMessage.textContent = JSON.parse(this.response).error.message;
                    }
                }
            };
            req.send();
        }

        // Helper function to format date (YYYY-MM-DD)
        function formatDate(dateString) {
            var date = new Date(dateString);
            return date.toISOString().split('T')[0]; // Returns 'YYYY-MM-DD'
        }

        // Helper function to format time (HH:MM:SS)
        function formatTime(dateString) {
            var date = new Date(dateString);
            return date.toISOString().split('T')[1].split('Z')[0]; // Returns 'HH:MM:SS'
        }

        function renderNFCTrackingData(nfctrackings) {
            nfctrackingsTableBody.innerHTML = "";
            nfctrackings.forEach(function (tracking) {
                var row = document.createElement("tr");

                var nameCell = document.createElement("td");
                nameCell.textContent = tracking.izx_name;

                var tagIdCell = document.createElement("td");
                tagIdCell.textContent = tracking.izx_tagid;
                tagIdCell.classList.add("tag-id");

                var timestampCell = document.createElement("td");
                timestampCell.textContent = formatDate(tracking.izx_timestamp);

                var timeInCell = document.createElement("td");
                timeInCell.textContent = formatTime(tracking.izx_timein);

                var timeOutCell = document.createElement("td");
                timeOutCell.textContent = formatTime(tracking.izx_timeout);

                var durationCell = document.createElement("td");
                durationCell.textContent = tracking.izx_duration;

                var inoutCell = document.createElement("td");
                inoutCell.textContent = tracking.izx_in_out;

                row.appendChild(nameCell);
                row.appendChild(tagIdCell);
                row.appendChild(timestampCell);
                row.appendChild(timeInCell);
                row.appendChild(timeOutCell);
                row.appendChild(durationCell);
                row.appendChild(inoutCell);

                nfctrackingsTableBody.appendChild(row);
            });

            message.textContent = "NFC tracking data loaded successfully.";
            nfctrackingsTable.classList.remove("hidden");
        }

        function searchByTagID() {
            var filterValue = searchBar.value.toUpperCase();
            var rows = nfctrackingsTableBody.getElementsByTagName("tr");

            for (var i = 0; i < rows.length; i++) {
                var tagIdCell = rows[i].getElementsByClassName("tag-id")[0];
                if (tagIdCell) {
                    var tagId = tagIdCell.textContent.toUpperCase();
                    rows[i].style.display = tagId.indexOf(filterValue) > -1 ? "" : "none";
                }
            }
        }

















        //// Variables for buttons and sections
        //var showNFCButton = document.getElementById("showNFCButton");
        //var showUsersButton = document.getElementById("showUsersButton");
        //var showMonthWiseDataButton = document.getElementById("showMonthWiseDataButton");

        //var nfcTrackingSection = document.getElementById("nfcTrackingSection");
        //var usersSection = document.getElementById("usersSection");
        //var monthSection = Document.getElementById("monthSection");

        //// Add event listeners to toggle between sections
        //showNFCButton.addEventListener("click", function () {
        //    toggleVisibility('nfc');
        //});

        //showUsersButton.addEventListener("click", function () {
        //    toggleVisibility('users');
        //});

        //showMonthButtons.addEventListener("click", function () {
        //    toggleVisibility('month');
        //});

        //// Function to toggle visibility between NFC Tracking and Users section
        //function toggleVisibility(section) {
        //    if (section === 'nfc') {
        //        nfcTrackingSection.classList.remove('hidden');
        //        usersSection.classList.add('hidden');
        //        monthSection.classList.add('hidden');
        //    } else if (section === 'users') {
        //        usersSection.classList.remove('hidden');
        //        nfcTrackingSection.classList.add('hidden');
        //        monthSection.classList.add('hidden');
        //    } else if (section === 'month') {
        //        monthSection.classList.remove('hidden');
        //        nfcTrackingSection.classList.add('hidden');
        //        monthSection.classList.add('hidden');
        //    }
        //}

        //document.getElementById('login').addEventListener('click', function () {
        //    document.getElementById('login').classList.add('hidden');
        //    document.getElementById('logout').classList.remove('hidden');
        //});

        //document.getElementById('logout').addEventListener('click', function () {
        //    document.getElementById('logout').classList.add('hidden');
        //    document.getElementById('login').classList.remove('hidden');
        //});




        //// Your existing NFC Tracking Data and Get Users code goes here
        //var organizationURI = "https://izenixlearn.api.crm.dynamics.com";      // CRM URL
        //var tenant = "izenixlearn.onmicrosoft.com";                            // Azure AD tenant
        //var clientId = "78d9abf2-52c4-4f68-a69d-dfab8a564eab";                 // Client ID from Azure app registration
        //var pageUrl = "https://www.izenix.com/SimpleSPA.html";                 // Redirect URL

        //var authContext, user, loginButton, logoutButton, userLoginButton, userLogoutButton, getUsersButton, usersTable, getNFCTrackingDataButton, searchBar, nfctrackingsTable, nfctrackingsTableBody, usersTableBody, getMonthButton, monthwisetable, monthwisetableBody, message, errorMessage;

        //// ADAL configuration
        //var endpoints = {
        //    orgUri: organizationURI
        //};

        //window.config = {
        //    tenant: tenant,
        //    clientId: clientId,
        //    postLogoutRedirectUri: pageUrl,
        //    endpoints: endpoints,
        //    cacheLocation: 'localStorage' // Store tokens in localStorage
        //};

        //document.onreadystatechange = function () {
        //    if (document.readyState === "complete") {
        //        // Get references to the necessary DOM elements
        //        message = document.getElementById("message");
        //        errorMessage = document.getElementById("errorMessage");

        //        // Login and Logout buttons
        //        loginButton = document.getElementById("login");
        //        logoutButton = document.getElementById("logout");

        //        // NFC Tracking Data elements
        //        getNFCTrackingDataButton = document.getElementById("getNFCTrackingData");
        //        searchBar = document.getElementById("searchBar");
        //        nfctrackingsTable = document.getElementById("nfctrackingsTable");
        //        nfctrackingsTableBody = document.getElementById("nfctrackingsTableBody");

        //        // Users-related elements
        //        getUsersButton = document.getElementById("getUsers");
        //        usersTable = document.getElementById("usersTable");
        //        usersTableBody = document.getElementById("usersTableBody");

        //        // Month Wise Data elements
        //        getMonthButton = document.getElementById("monthData");
        //        monthwisetable = document.getElementById("monthwisetable");
        //        monthwisetableBody = document.getElementById("monthwisetableBody");



        //        // Add event listeners for NFC login/logout
        //        loginButton.addEventListener("click", login);
        //        logoutButton.addEventListener("click", logout);

        //        // Add event listeners for data retrieval and search
        //        getNFCTrackingDataButton.addEventListener("click", getNFCTrackingData);
        //        getUsersButton.addEventListener("click", getUsers);
        //        getMonthButton.addEventListener("click", monthData);

        //        // Add event listener for search functionality
        //        searchBar.addEventListener("input", searchByTagID);


        //        authenticate();

        //        if (user) {
        //            // Hide login button and show logout button when the user is logged in
        //            loginButton.style.display = "none";
        //            logoutButton.style.display = "block";

        //            // Show the Get Users button
        //            getUsersButton.style.display = "block";

        //            // Show the NFC tracking data button and search bar by removing "none" class
        //            getNFCTrackingDataButton.style.display = "block";
        //            searchBar.style.display = "block";

        //            // Display greeting message to the logged-in user
        //            var greetingContainer = document.getElementById("greetingMessage");
        //            var helloMessage = document.createElement("span");
        //            helloMessage.textContent = "Hello " + user.profile.name;
        //            greetingContainer.appendChild(helloMessage);

        //            // Optionally, style the message if needed
        //            helloMessage.style.marginLeft = "10px";
        //            helloMessage.style.fontWeight = "bold";



        //        } else {
        //            // Show login button and hide logout button when the user is logged out
        //            loginButton.style.display = "block";
        //            logoutButton.style.display = "none";

        //            // Hide the Get Users button
        //            getUsersButton.style.display = "none";

        //            // Hide the NFC tracking data button, search bar, and table by adding "none" class
        //            getNFCTrackingDataButton.style.display = "none";
        //            searchBar.style.display = "none";
        //        }
        //    }
        //};

        //// Function to authenticate the user
        //function authenticate() {
        //    try {
        //        authContext = new AuthenticationContext(config);
        //        var isCallback = authContext.isCallback(window.location.hash);
        //        if (isCallback) {
        //            authContext.handleWindowCallback();
        //        }
        //        var loginError = authContext.getLoginError();
        //        if (isCallback && !loginError) {
        //            window.location = authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST);
        //        } else if (loginError) {
        //            errorMessage.textContent = loginError;
        //        }

        //        user = authContext.getCachedUser();
        //    } catch (e) {
        //        console.error("Authentication error:", e);
        //        errorMessage.textContent = "Authentication initialization failed.";
        //    }
        //}

        //// Login function
        //function login() {
        //    try {
        //        authContext.login();
        //    } catch (e) {
        //        console.error("Login error:", e);
        //        errorMessage.textContent = "Login failed.";
        //    }
        //}

        //// Logout function
        //function logout() {
        //    authContext.logOut();
        //    usersTable.style.display = "none";
        //    usersTableBody.innerHTML = "";
        //}

        //// Function to get users
        //function getUsers() {
        //    getUsersButton.disabled = true;
        //    message.textContent = "Retrieving users...";
        //    authContext.acquireToken(organizationURI, retrieveUsers);
        //}

        //// Function to retrieve users
        //function retrieveUsers(error, token) {
        //    if (error || !token) {
        //        console.error("Token error:", error);
        //        errorMessage.textContent = 'ADAL error occurred: ' + error;
        //        return;
        //    }

        //    var req = new XMLHttpRequest();
        //    req.open("GET", encodeURI(organizationURI + "/api/data/v9.2/contacts?$select=fullname,emailaddress1,mobilephone,izx_tagid,izx_nfccounter&$filter=izx_tagid ne null"), true);
        //    req.setRequestHeader("Authorization", "Bearer " + token);
        //    req.setRequestHeader("Accept", "application/json");
        //    req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
        //    req.setRequestHeader("OData-MaxVersion", "4.0");
        //    req.setRequestHeader("OData-Version", "4.0");

        //    req.onreadystatechange = function () {
        //        if (this.readyState === 4) {
        //            req.onreadystatechange = null;
        //            if (this.status === 200) {
        //                var users = JSON.parse(this.response).value;
        //                renderUsers(users);
        //            } else {
        //                var error = JSON.parse(this.response).error;
        //                console.error("Error retrieving users:", error.message);
        //                errorMessage.textContent = error.message;
        //            }
        //        }
        //    };
        //    req.send();
        //}

        //// Function to render users into the table
        //function renderUsers(users) {
        //    usersTableBody.innerHTML = ''; // Clear previous results
        //    users.forEach(function (user) {
        //        var row = document.createElement("tr");

        //        var tagId = document.createElement("td");
        //        tagId.textContent = user.izx_tagid;

        //        var nameCell = document.createElement("td");
        //        nameCell.textContent = user.fullname;

        //        var emailCell = document.createElement("td");
        //        emailCell.textContent = user.emailaddress1;

        //        var mobilePhone = document.createElement("td");
        //        mobilePhone.textContent = user.mobilephone;

        //        var nfcCounterCell = document.createElement("tb");
        //        nfcCounterCell.textContent = user.izx_nfccounter;

        //        var tagIdCell = document.createElement("td");
        //        var tagIdButton = document.createElement("button");
        //        tagIdButton.textContent = "Show";
        //        tagIdButton.addEventListener("click", function () {
        //            showTagIdData(user.izx_tagid); // Call function to show data user.izx_tagid
        //        });
        //        tagIdCell.appendChild(tagIdButton);

        //        row.appendChild(tagId);
        //        row.appendChild(nameCell);
        //        row.appendChild(emailCell);
        //        row.appendChild(mobilePhone);
        //        row.appendChild(nfcCounterCell);
        //        row.appendChild(tagIdCell);
        //        usersTableBody.appendChild(row);
        //    });
        //    usersTable.style.display = 'table';
        //    getUsersButton.disabled = false;
        //    message.textContent = '';
        //}

        //function showTagIdData(tagId) {
        //    debugger;
        //    authContext.acquireToken(organizationURI, function (error, token) {
        //        if (error || !token) {
        //            console.error("Token error:", error);
        //            errorMessage.textContent = 'ADAL error occurred: ' + error;
        //            return;
        //        }

        //        var req = new XMLHttpRequest();
        //        // Ensure proper concatenation of $select and $filter
        //        var filterQuery = `$filter=izx_tagid eq '${tagId}'`;
        //        var selectQuery = `$select=izx_tagid,izx_timein,izx_timeout,izx_duration,izx_in_out,izx_timestamp`;
        //        var apiUrl = encodeURI(organizationURI + "/api/data/v9.2/izx_nfctrackings?" + selectQuery + "&" + filterQuery);
        //        req.open("GET", apiUrl, true);
        //        req.setRequestHeader("Authorization", "Bearer " + token);
        //        req.setRequestHeader("Accept", "application/json");
        //        req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
        //        req.setRequestHeader("OData-MaxVersion", "4.0");
        //        req.setRequestHeader("OData-Version", "4.0");

        //        req.onreadystatechange = function () {
        //            if (this.readyState === 4) {
        //                req.onreadystatechange = null;
        //                if (this.status === 200) {
        //                    var tagDetails = JSON.parse(this.response).value;

        //                    // Check if records were returned for the tagId
        //                    if (tagDetails.length > 0) {
        //                        // Clear any existing rows in the modal table
        //                        var modalTableBody = document.getElementById("modalTagDetailsTableBody");
        //                        modalTableBody.innerHTML = "";

        //                        // Loop through each record and append it to the modal table
        //                        tagDetails.forEach(function (record) {
        //                            var row = document.createElement("tr");

        //                            // Helper function to format date (YYYY-MM-DD)
        //                            function formatDate(dateString) {
        //                                // Check if dateString is valid
        //                                if (!dateString) {
        //                                    return 'N/A';
        //                                }

        //                                var date = new Date(dateString);
        //                                // Check if the date is valid
        //                                if (isNaN(date.getTime())) {
        //                                    return 'Invalid Date';
        //                                }
        //                                return date.toISOString().split('T')[0]; // Returns 'YYYY-MM-DD'
        //                            }

        //                            // Helper function to format time (HH:MM:SS)
        //                            function formatTime(dateString) {
        //                                // Check if dateString is valid
        //                                if (!dateString) {
        //                                    return 'N/A';
        //                                }

        //                                var date = new Date(dateString);
        //                                // Check if the date is valid
        //                                if (isNaN(date.getTime())) {
        //                                    return 'Invalid Time';
        //                                }
        //                                return date.toISOString().split('T')[1].split('Z')[0]; // Returns 'HH:MM:SS'
        //                            }

        //                            // Create and append table cells for each field
        //                            var tagIdCell = document.createElement("td");
        //                            tagIdCell.textContent = record.izx_tagid || 'N/A';
        //                            row.appendChild(tagIdCell);

        //                            var timestampCell = document.createElement("td");
        //                            timestampCell.textContent = formatDate(record.izx_timestamp) || 'N/A';
        //                            row.appendChild(timestampCell);

        //                            var timeInCell = document.createElement("td");
        //                            timeInCell.textContent = formatTime(record.izx_timein) || 'N/A';
        //                            row.appendChild(timeInCell);

        //                            var timeOut = document.createElement("td");
        //                            timeOut.textContent = formatTime(record.izx_timeout) || 'N/A';
        //                            row.appendChild(timeOut);

        //                            var durationCell = document.createElement("td");
        //                            durationCell.textContent = record.izx_duration || 'N/A';
        //                            row.appendChild(durationCell);

        //                            var inOutCell = document.createElement("td");
        //                            inOutCell.textContent = record.izx_in_out || 'N/A';
        //                            row.appendChild(inOutCell);

        //                            // Append the row to the modal table body
        //                            modalTableBody.appendChild(row);
        //                        });

        //                        // Open the modal to display the data
        //                        var modal = document.getElementById("tagDetailsModal");
        //                        modal.style.display = "block";

        //                    } else {
        //                        alert("No records found for the provided tag ID.");
        //                        //console.error("No records found for the provided tag ID.");
        //                        //errorMessage.textContent = 'No records found for the provided tag ID.';
        //                    }
        //                } else {
        //                    var error = JSON.parse(this.response).error;
        //                    console.error("Error retrieving tag details:", error.message);
        //                    errorMessage.textContent = error.message;
        //                }
        //            }
        //        };
        //        req.send();
        //    });
        //}

        //// When the user clicks on the close button, close the modal
        //var closeModal = document.querySelector(".close");
        //closeModal.onclick = function () {
        //    var modal = document.getElementById("tagDetailsModal");
        //    modal.style.display = "none";
        //};

        //// When the user clicks anywhere outside of the modal, close it
        //window.onclick = function (event) {
        //    var modal = document.getElementById("tagDetailsModal");
        //    if (event.target === modal) {
        //        modal.style.display = "none";
        //    }
        //};


        //// Existing NFC Tracking Data code goes here
        //var user, authContext, message, errorMessage, loginButton, logoutButton, getNFCTrackingDataButton, searchBar, nfctrackingsTable, nfctrackingsTableBody;

        //var endpoints = { orgUri: organizationURI };

        //window.config = {
        //    tenant: tenant,
        //    clientId: clientId,
        //    postLogoutRedirectUri: pageUrl,
        //    endpoints: endpoints,
        //    cacheLocation: 'localStorage',
        //};

        //function toggleLoggedInState(isLoggedIn) {
        //    if (isLoggedIn) {
        //        loginButton.classList.add("hidden");
        //        logoutButton.classList.remove("hidden");
        //        getNFCTrackingDataButton.style.display = "block";
        //        searchBar.style.display = "block";
        //    } else {
        //        loginButton.classList.remove("hidden");
        //        logoutButton.classList.add("hidden");
        //        getNFCTrackingDataButton.style.display = "none";
        //        searchBar.style.display = "none";
        //        nfctrackingsTable.classList.add("hidden");
        //    }
        //}

        //function login() {
        //    authContext.login();
        //}

        //function logout() {
        //    authContext.logOut();
        //    nfctrackingsTableBody.innerHTML = "";
        //    nfctrackingsTable.style.display = "none";
        //    toggleLoggedInState(false);
        //}

        //function getNFCTrackingData() {
        //    getNFCTrackingDataButton.disabled = false;
        //    message.textContent = "Retrieving NFC tracking data...";
        //    authContext.acquireToken(organizationURI, retrieveNFCTrackingData);
        //}

        //function retrieveNFCTrackingData(error, token) {
        //    if (error || !token) {
        //        errorMessage.textContent = 'ADAL error occurred: ' + error;
        //        return;
        //    }

        //    var req = new XMLHttpRequest();
        //    req.open("GET", encodeURI(organizationURI + "/api/data/v9.2/izx_nfctrackings?$select=izx_name,izx_tagid,izx_status,izx_timestamp,izx_timein,izx_timeout,izx_duration,izx_in_out"), true);
        //    req.setRequestHeader("Authorization", "Bearer " + token);
        //    req.setRequestHeader("Accept", "application/json");
        //    req.setRequestHeader("Content-Type", "application/json; charset=utf-8");

        //    req.onreadystatechange = function () {
        //        if (this.readyState === 4) {
        //            if (this.status === 200) {
        //                var nfctrackings = JSON.parse(this.response).value;
        //                renderNFCTrackingData(nfctrackings);
        //            } else {
        //                errorMessage.textContent = JSON.parse(this.response).error.message;
        //            }
        //        }
        //    };
        //    req.send();
        //}

        //// Helper function to format date (YYYY-MM-DD)
        //function formatDate(dateString) {
        //    var date = new Date(dateString);
        //    return date.toISOString().split('T')[0]; // Returns 'YYYY-MM-DD'
        //}

        //// Helper function to format time (HH:MM:SS)
        //function formatTime(dateString) {
        //    var date = new Date(dateString);
        //    return date.toISOString().split('T')[1].split('Z')[0]; // Returns 'HH:MM:SS'
        //}

        //function renderNFCTrackingData(nfctrackings) {
        //    nfctrackingsTableBody.innerHTML = "";
        //    nfctrackings.forEach(function (tracking) {
        //        var row = document.createElement("tr");

        //        var nameCell = document.createElement("td");
        //        nameCell.textContent = tracking.izx_name;

        //        var tagIdCell = document.createElement("td");
        //        tagIdCell.textContent = tracking.izx_tagid;
        //        tagIdCell.classList.add("tag-id");

        //        var timestampCell = document.createElement("td");
        //        timestampCell.textContent = formatDate(tracking.izx_timestamp);

        //        var timeInCell = document.createElement("td");
        //        timeInCell.textContent = formatTime(tracking.izx_timein);

        //        var timeOutCell = document.createElement("td");
        //        timeOutCell.textContent = formatTime(tracking.izx_timeout);

        //        var durationCell = document.createElement("td");
        //        durationCell.textContent = tracking.izx_duration;

        //        var inoutCell = document.createElement("td");
        //        inoutCell.textContent = tracking.izx_in_out;

        //        row.appendChild(nameCell);
        //        row.appendChild(tagIdCell);
        //        row.appendChild(timestampCell);
        //        row.appendChild(timeInCell);
        //        row.appendChild(timeOutCell);
        //        row.appendChild(durationCell);
        //        row.appendChild(inoutCell);

        //        nfctrackingsTableBody.appendChild(row);
        //    });

        //    message.textContent = "NFC tracking data loaded successfully.";
        //    nfctrackingsTable.classList.remove("hidden");
        //}

        //function searchByTagID() {
        //    var filterValue = searchBar.value.toUpperCase();
        //    var rows = nfctrackingsTableBody.getElementsByTagName("tr");

        //    for (var i = 0; i < rows.length; i++) {
        //        var tagIdCell = rows[i].getElementsByClassName("tag-id")[0];
        //        if (tagIdCell) {
        //            var tagId = tagIdCell.textContent.toUpperCase();
        //            rows[i].style.display = tagId.indexOf(filterValue) > -1 ? "" : "none";
        //        }
        //    }
        //}



        //// Month Wise Data
        //function fetchData() {
        //    var month = document.getElementById("monthInput").value;
        //    var year = document.getElementById("yearInput").value;

        //    req.open("GET", encodeURI(organizationURI + "/api/data/v9.2/izx_nfctrackings?$select=izx_name,izx_tagid,izx_status,izx_timestamp,izx_timein,izx_timeout,izx_duration,izx_in_out&$filter=month(izx_timestamp) eq " + month + " and year(izx_timestamp) eq " + year), true);
        //    req.send();
        //}

        //// Monthly Wise Data code goes here
        //var user, authContext, message, errorMessage, loginButton, logoutButton, getNFCTrackingDataButton, searchBar, nfctrackingsTable, nfctrackingsTableBody;

        //var endpoints = { orgUri: organizationURI };

        //window.config = {
        //    tenant: tenant,
        //    clientId: clientId,
        //    postLogoutRedirectUri: pageUrl,
        //    endpoints: endpoints,
        //    cacheLocation: 'localStorage',
        //};

        //function toggleLoggedInState(isLoggedIn) {
        //    if (isLoggedIn) {
        //        loginButton.classList.add("hidden");
        //        logoutButton.classList.remove("hidden");
        //        getNFCTrackingDataButton.style.display = "block";
        //        searchBar.style.display = "block";
        //    } else {
        //        loginButton.classList.remove("hidden");
        //        logoutButton.classList.add("hidden");
        //        getNFCTrackingDataButton.style.display = "none";
        //        searchBar.style.display = "none";
        //        nfctrackingsTable.classList.add("hidden");
        //    }
        //}

        //function login() {
        //    authContext.login();
        //}

        //function logout() {
        //    authContext.logOut();
        //    nfctrackingsTableBody.innerHTML = "";
        //    nfctrackingsTable.style.display = "none";
        //    toggleLoggedInState(false);
        //}

        //function getNFCTrackingData() {
        //    getNFCTrackingDataButton.disabled = false;
        //    message.textContent = "Retrieving NFC tracking data...";
        //    authContext.acquireToken(organizationURI, retrieveNFCTrackingData);
        //}

        //function retrieveNFCTrackingData(error, token) {
        //    if (error || !token) {
        //        errorMessage.textContent = 'ADAL error occurred: ' + error;
        //        return;
        //    }

        //    var req = new XMLHttpRequest();
        //    req.open("GET", encodeURI(organizationURI + "/api/data/v9.2/izx_nfctrackings?$select=izx_name,izx_tagid,izx_status,izx_timestamp,izx_timein,izx_timeout,izx_duration,izx_in_out"), true);
        //    req.setRequestHeader("Authorization", "Bearer " + token);
        //    req.setRequestHeader("Accept", "application/json");
        //    req.setRequestHeader("Content-Type", "application/json; charset=utf-8");

        //    req.onreadystatechange = function () {
        //        if (this.readyState === 4) {
        //            if (this.status === 200) {
        //                var nfctrackings = JSON.parse(this.response).value;
        //                renderNFCTrackingData(nfctrackings);
        //            } else {
        //                errorMessage.textContent = JSON.parse(this.response).error.message;
        //            }
        //        }
        //    };
        //    req.send();
        //}


        //// Helper function to format date (YYYY-MM-DD)
        //function formatDate(dateString) {
        //    var date = new Date(dateString);
        //    return date.toISOString().split('T')[0]; // Returns 'YYYY-MM-DD'
        //}

        //// Helper function to format time (HH:MM:SS)
        //function formatTime(dateString) {
        //    var date = new Date(dateString);
        //    return date.toISOString().split('T')[1].split('Z')[0]; // Returns 'HH:MM:SS'
        //}

        //function renderNFCTrackingData(nfctrackings) {
        //    nfctrackingsTableBody.innerHTML = "";
        //    nfctrackings.forEach(function (tracking) {
        //        var row = document.createElement("tr");

        //        var nameCell = document.createElement("td");
        //        nameCell.textContent = tracking.izx_name;

        //        var tagIdCell = document.createElement("td");
        //        tagIdCell.textContent = tracking.izx_tagid;
        //        tagIdCell.classList.add("tag-id");

        //        var timestampCell = document.createElement("td");
        //        timestampCell.textContent = formatDate(tracking.izx_timestamp);

        //        var timeInCell = document.createElement("td");
        //        timeInCell.textContent = formatTime(tracking.izx_timein);

        //        var timeOutCell = document.createElement("td");
        //        timeOutCell.textContent = formatTime(tracking.izx_timeout);

        //        var durationCell = document.createElement("td");
        //        durationCell.textContent = tracking.izx_duration;

        //        var inoutCell = document.createElement("td");
        //        inoutCell.textContent = tracking.izx_in_out;

        //        row.appendChild(nameCell);
        //        row.appendChild(tagIdCell);
        //        row.appendChild(timestampCell);
        //        row.appendChild(timeInCell);
        //        row.appendChild(timeOutCell);
        //        row.appendChild(durationCell);
        //        row.appendChild(inoutCell);

        //        nfctrackingsTableBody.appendChild(row);
        //    });

        //    message.textContent = "NFC tracking data loaded successfully.";
        //    nfctrackingsTable.classList.remove("hidden");
        //}

        //function searchByTagID() {
        //    var filterValue = searchBar.value.toUpperCase();
        //    var rows = nfctrackingsTableBody.getElementsByTagName("tr");

        //    for (var i = 0; i < rows.length; i++) {
        //        var tagIdCell = rows[i].getElementsByClassName("tag-id")[0];
        //        if (tagIdCell) {
        //            var tagId = tagIdCell.textContent.toUpperCase();
        //            rows[i].style.display = tagId.indexOf(filterValue) > -1 ? "" : "none";
        //        }
        //    }
        //}
    </script>

</body>
</html>-->







<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Tracking and Users</title>

    <style>
        /* General Styling */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }

        h1, h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 15px;
        }

        #nfcTrackingSection, #usersSection {
            background-color: white;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Flexbox Layout for Buttons */
        .container {
            display: flex;
            justify-content: space-between; /* Space between left and right buttons */
            align-items: center;
            margin-bottom: 20px;
        }

        /* Button Styling */
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

            button:hover {
                background-color: #45a049;
                transform: translateY(-2px);
            }

            button:disabled {
                background-color: #ddd;
                cursor: not-allowed;
            }

        #showNFCButton, #showUsersButton {
            background-color: #007bff;
        }

            #showNFCButton:hover, #showUsersButton:hover {
                background-color: #0056b3;
            }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

            table caption {
                font-size: 20px;
                font-weight: bold;
                margin-bottom: 10px;
                text-align: left;
            }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
            font-size: 16px;
            color: #555;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        td {
            font-size: 14px;
            color: #333;
        }

        /* Hidden class to toggle visibility */
        .hidden {
            display: none;
        }

        /* Styling for NFC and Users buttons on the left side */
        .nfc-users-buttons {
            display: flex;
            flex-direction: column;
        }

            .nfc-users-buttons button {
                width: 220px;
                padding: 12px;
                font-size: 16px;
                background-color: #28a745;
            }

                .nfc-users-buttons button:hover {
                    background-color: #218838;
                }

        /* Styling for Login and Logout buttons on the right side */
        .auth-buttons {
            display: flex;
            flex-direction: row;
        }

            .auth-buttons button {
                width: 120px;
                padding: 10px;
                font-size: 16px;
                background-color: #007bff;
            }

                .auth-buttons button:hover {
                    background-color: #0056b3;
                }

        /* Show Button Styling */
        #tagIdButton {
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            font-size: 16px;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

            #tagIdButton:hover {
                background-color: #45a049;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
                transform: translateY(-5px);
            }

            #tagIdButton:focus {
                outline: none;
                box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.5);
            }

        /* Message & Error Styling */
        #message, #userMessage {
            margin-top: 10px;
            color: #4CAF50;
            font-weight: bold;
        }

        #errorMessage, #userErrorMessage {
            color: red;
            margin-top: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                align-items: center;
            }

            .nfc-users-buttons button, .auth-buttons button {
                width: 100%;
                max-width: 300px;
            }
        }

        /* The Modal (background) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }

        /* Modal Content/Box */
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        /* The Close Button */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }

        #errorMessage {
            color: red;
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }

        #greetingMessage {
            font-family: 'Arial', sans-serif;
            font-size: 10px;
            color: #333;
            background-color: #f9f9f9;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin: 10px 0;
            display: inline-block;
        }

        /* Container for the button and search bar */
        #nfcTrackingContainer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px;
        }

        /* Style for the NFC Tracking Data button */
        #getNFCTrackingData {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            cursor: pointer;
        }

            #getNFCTrackingData:hover {
                background-color: #218838;
            }

        /* Style for the search bar*/
        #searchBar {
            padding: 10px;
            font-size: 16px;
            width: 250px;
            border-radius: 5px;
            border: 1px solid #ccc;
            display: none;
            /*Initially hidden*/
        }

            #searchBar.active {
                display: block;
            }

        /* Styling for NFC and Users buttons on the left side */
        .nfc-users-buttons {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }

            .nfc-users-buttons button {
                width: 220px;
                padding: 12px;
                font-size: 16px;
                background-color: #28a745;
            }

                .nfc-users-buttons button:hover {
                    background-color: #218838;
                }

        /* Responsive design: Stack buttons vertically on smaller screens */
        @media (max-width: 768px) {
            .nfc-users-buttons {
                flex-direction: column;
                align-items: center;
            }

                .nfc-users-buttons button {
                    width: 100%;
                    max-width: 300px;
                }
        }



        /* New CSS Style*/
        /* General body style */
        body {
            color: #666;
            font-family: Lato, sans-serif;
            font-size: 13px;
            font-weight: 400;
            line-height: 20px;
            margin: 0;
            padding: 0;
        }

        /* Header styling */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 2px solid #ccc;
        }

        .logo {
            flex: 1;
        }

        .logo-img {
            height: 50px;
            width: auto;
        }

        /* Dropdown menu styles for NFC */
        .dropdown {
            position: relative;
        }

        .menu-button {
            font-size: 14px;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            color: #fff;
            background-color: #666;
            transition: background-color 0.3s;
        }

            .menu-button:hover {
                background-color: #333;
            }

        /* Dropdown content (hidden by default) */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            z-index: 1;
            box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
        }

        /* Show the dropdown menu when hover over the menu button */
        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* Style for the buttons inside the dropdown */
        .dropdown-content button {
            font-size: 14px;
            padding: 10px 15px;
            margin: 0;
            border: none;
            cursor: pointer;
            width: 100%;
            text-align: left;
            color: #666;
            background-color: #fff;
            transition: background-color 0.3s;
        }

            .dropdown-content button:hover {
                background-color: #ddd;
            }

        /* Authentication section on the right */
        .auth-section {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

            .auth-section span#greetingMessage {
                font-weight: bold;
                margin-right: 15px;
            }

            .auth-section button {
                font-size: 14px;
                padding: 10px 15px;
                border: none;
                cursor: pointer;
                color: #fff;
                background-color: #666;
                transition: background-color 0.3s;
            }

                .auth-section button:hover {
                    background-color: #333;
                }

        /* NFC and Users table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }

            table th, table td {
                padding: 10px;
                border: 1px solid #ccc;
                text-align: left;
            }

            table th {
                background-color: #666;
                color: #fff;
            }

            table tbody tr:nth-child(even) {
                background-color: #f2f2f2;
            }

    </style>

    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.17/js/adal.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.29.0/js/msal-browser.min.js"></script>

</head>
<body>

    <!-- Header section -->
    <header class="header">
        <div class="logo">
            <img src="your-logo-url.png" alt="Logo" class="logo-img">
        </div>

        <!-- NFC Menu with right-aligned dropdown -->
        <div class="dropdown">
            <button class="menu-button">NFC</button>
            <div class="dropdown-content">
                <button id="showNFCButton">Show NFC Tracking Data</button>
                <button id="showUsersButton">Show Users</button>
                <button id="showMonthlywiseButton">Month Wise Data</button>
            </div>
        </div>

        <!-- Authentication section on the right -->
        <div class="auth-section">
            <span id="greetingMessage"></span>
            <button id="login">Login</button>
            <button id="logout" class="hidden">Logout</button>
        </div>
    </header>

    <!-- NFC Tracking Data Section -->
    <div id="nfcTrackingSection">
        <div id="nfcTrackingContainer">
            <button id="getNFCTrackingData">NFC Tracking Data</button>
            <input type="text" id="searchBar" class="hidden" placeholder="Search by Tag ID...">
        </div>

        <div id="message"></div>
        <table id="nfctrackingsTable" class="hidden">
            <caption>NFC Tracking Data</caption>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Tag ID</th>
                    <th>Timestamp</th>
                    <th>Time In</th>
                    <th>Time Out</th>
                    <th>Time Duration</th>
                    <th>Time In Out</th>
                </tr>
            </thead>
            <tbody id="nfctrackingsTableBody"></tbody>
        </table>
    </div>

    <!-- Get Users Section -->
    <div id="usersSection" class="hidden">
        <h1>Get Users from Dynamics 365</h1>
        <div id="errorMessage"></div>
        <div id="userMessage"></div>
        <div id="userErrorMessage" style="color: red;"></div>
        <button id="getUsers" style="display: none;">Get Users</button>

        <table id="usersTable">
            <thead>
                <tr>
                    <th>TagID</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Phone Number</th>
                    <th>NFC Counter</th>
                    <th>-</th>
                </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
        </table>
    </div>

    <!-- Modal Structure -->
    <div id="tagDetailsModal" class="modal hidden">
        <div class="modal-content">
            <div id="userMessage"></div>
            <span class="close">&times;</span>
            <h2>Tag Details</h2>
            <table>
                <thead>
                    <tr>
                        <th>Tag ID</th>
                        <th>Timestamp</th>
                        <th>Time IN</th>
                        <th>Time Out</th>
                        <th>Duration</th>
                        <th>In/Out</th>
                    </tr>
                </thead>
                <tbody id="modalTagDetailsTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Month Wise Data Section -->
    <div id="monthSection" class="hidden">
        <h2>Fetch Month-wise NFC Tracking Data</h2>
        <label for="monthYearInput">Select Month and Year: </label>
        <input type="month" id="monthYearInput" required>
        <br><br>
        <button id="monthData">Get Data</button>
        <p id="monthMessage"></p>
        <table id="monthwisetable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Tag ID</th>
                    <th>Timestamp</th>
                    <th>Time In</th>
                    <th>Time Out</th>
                    <th>Duration</th>
                    <th>In/Out</th>
                </tr>
            </thead>
            <tbody id="monthwisetableBody"></tbody>
        </table>
    </div>

    <script type="text/javascript">
        "use strict";

        // Variables for buttons and sections
        var showNFCButton = document.getElementById("showNFCButton");
        var showUsersButton = document.getElementById("showUsersButton");
        var showMonthWiseDataButton = document.getElementById("showMonthWiseDataButton");

        var nfcTrackingSection = document.getElementById("nfcTrackingSection");
        var usersSection = document.getElementById("usersSection");
        var monthSection = document.getElementById("monthSection");

        // Add event listeners to toggle between sections
        showNFCButton.addEventListener("click", function () {
            toggleVisibility('nfc');
        });

        showUsersButton.addEventListener("click", function () {
            toggleVisibility('users');
        });

        showMonthWiseDataButton.addEventListener("click", function () {
            toggleVisibility('month');
        });

        // Function to toggle visibility between NFC Tracking and Users section
        function toggleVisibility(section) {
            if (section === 'nfc') {
                nfcTrackingSection.classList.remove('hidden');
                usersSection.classList.add('hidden');
                monthSection.classList.add('hidden');
            } else if (section === 'users') {
                usersSection.classList.remove('hidden');
                nfcTrackingSection.classList.add('hidden');
                monthSection.classList.add('hidden');
            } else if (section === 'month') {
                monthSection.classList.remove('hidden');
                usersSection.classList.add('hidden');
                nfcTrackingSection.classList.add('hidden');
            }
        }

        document.getElementById('login').addEventListener('click', function () {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('logout').classList.remove('hidden');
        });

        document.getElementById('logout').addEventListener('click', function () {
            document.getElementById('logout').classList.add('hidden');
            document.getElementById('login').classList.remove('hidden');
        });


        // Your existing NFC Tracking Data and Get Users code goes here
        var organizationURI = "https://izenixlearn.api.crm.dynamics.com";      // CRM URL
        var tenant = "izenixlearn.onmicrosoft.com";                            // Azure AD tenant
        var clientId = "78d9abf2-52c4-4f68-a69d-dfab8a564eab";                 // Client ID from Azure app registration
        var pageUrl = "https://www.izenix.com/SimpleSPA.html";                 // Redirect URL

        var authContext, user, loginButton, logoutButton, userLoginButton, userLogoutButton, getUsersButton, usersTable, getNFCTrackingDataButton, searchBar, nfctrackingsTable, nfctrackingsTableBody, usersTableBody, monthDataButton, monthTable, monthTableBody, message, errorMessage;

        // ADAL configuration
        var endpoints = {
            orgUri: organizationURI
        };

        window.config = {
            tenant: tenant,
            clientId: clientId,
            postLogoutRedirectUri: pageUrl,
            endpoints: endpoints,
            cacheLocation: 'localStorage' // Store tokens in localStorage
        };

        document.onreadystatechange = function () {
            if (document.readyState === "complete") {
                // Get references to the necessary DOM elements
                message = document.getElementById("message");
                errorMessage = document.getElementById("errorMessage");

                // Login and Logout buttons
                loginButton = document.getElementById("login");
                logoutButton = document.getElementById("logout");

                // NFC Tracking Data elements
                getNFCTrackingDataButton = document.getElementById("getNFCTrackingData");
                searchBar = document.getElementById("searchBar");
                nfctrackingsTable = document.getElementById("nfctrackingsTable");
                nfctrackingsTableBody = document.getElementById("nfctrackingsTableBody");

                // Users-related elements
                getUsersButton = document.getElementById("getUsers");
                usersTable = document.getElementById("usersTable");
                usersTableBody = document.getElementById("usersTableBody");

                // Month elements
                getMonthDataButton = document.getElementById("monthData");
                monthTable = document.getElementById("monthwisetable");
                monthTableBody = document.getElementById("monthwisetableBody");


                // Add event listeners for NFC login/logout
                loginButton.addEventListener("click", login);
                logoutButton.addEventListener("click", logout);

                // Add event listeners for data retrieval and search
                getNFCTrackingDataButton.addEventListener("click", getNFCTrackingData);
                getUsersButton.addEventListener("click", getUsers);
                getMonthDataButton.addEventListener("click", monthData);

                // Add event listener for search functionality
                searchBar.addEventListener("input", searchByTagID);


                authenticate();

                if (user) {
                    // Hide login button and show logout button when the user is logged in
                    loginButton.style.display = "none";
                    logoutButton.style.display = "block";

                    // Show the Get Users button
                    getUsersButton.style.display = "block";

                    // Show the NFC tracking data button and search bar by removing "none" class
                    getNFCTrackingDataButton.style.display = "block";
                    searchBar.style.display = "block";

                    // Display greeting message to the logged-in user
                    var greetingContainer = document.getElementById("greetingMessage");
                    var helloMessage = document.createElement("span");
                    helloMessage.textContent = "Hello " + user.profile.name;
                    greetingContainer.appendChild(helloMessage);

                    // Optionally, style the message if needed
                    helloMessage.style.marginLeft = "10px";
                    helloMessage.style.fontWeight = "bold";



                } else {
                    // Show login button and hide logout button when the user is logged out
                    loginButton.style.display = "block";
                    logoutButton.style.display = "none";

                    // Hide the Get Users button
                    getUsersButton.style.display = "none";

                    // Hide the NFC tracking data button, search bar, and table by adding "none" class
                    getNFCTrackingDataButton.style.display = "none";
                    searchBar.style.display = "none";
                }
            }
        };

        // Function to authenticate the user
        function authenticate() {
            try {
                authContext = new AuthenticationContext(config);
                var isCallback = authContext.isCallback(window.location.hash);
                if (isCallback) {
                    authContext.handleWindowCallback();
                }
                var loginError = authContext.getLoginError();
                if (isCallback && !loginError) {
                    window.location = authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST);
                } else if (loginError) {
                    errorMessage.textContent = loginError;
                }

                user = authContext.getCachedUser();
            } catch (e) {
                console.error("Authentication error:", e);
                errorMessage.textContent = "Authentication initialization failed.";
            }
        }

        // Login function
        function login() {
            try {
                authContext.login();
            } catch (e) {
                console.error("Login error:", e);
                errorMessage.textContent = "Login failed.";
            }
        }

        // Logout function
        function logout() {
            authContext.logOut();
            usersTable.style.display = "none";
            usersTableBody.innerHTML = "";
        }

        // Function to get users
        function getUsers() {
            getUsersButton.disabled = true;
            message.textContent = "Retrieving users...";
            authContext.acquireToken(organizationURI, retrieveUsers);
        }

        // Function to retrieve users
        function retrieveUsers(error, token) {
            if (error || !token) {
                console.error("Token error:", error);
                errorMessage.textContent = 'ADAL error occurred: ' + error;
                return;
            }

            var req = new XMLHttpRequest();
            req.open("GET", encodeURI(organizationURI + "/api/data/v9.2/contacts?$select=fullname,emailaddress1,mobilephone,izx_tagid,izx_nfccounter&$filter=izx_tagid ne null"), true);
            req.setRequestHeader("Authorization", "Bearer " + token);
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
            req.setRequestHeader("OData-MaxVersion", "4.0");
            req.setRequestHeader("OData-Version", "4.0");

            req.onreadystatechange = function () {
                if (this.readyState === 4) {
                    req.onreadystatechange = null;
                    if (this.status === 200) {
                        var users = JSON.parse(this.response).value;
                        renderUsers(users);
                    } else {
                        var error = JSON.parse(this.response).error;
                        console.error("Error retrieving users:", error.message);
                        errorMessage.textContent = error.message;
                    }
                }
            };
            req.send();
        }

        // Function to render users into the table
        function renderUsers(users) {
            usersTableBody.innerHTML = ''; // Clear previous results
            users.forEach(function (user) {
                var row = document.createElement("tr");

                var tagId = document.createElement("td");
                tagId.textContent = user.izx_tagid;

                var nameCell = document.createElement("td");
                nameCell.textContent = user.fullname;

                var emailCell = document.createElement("td");
                emailCell.textContent = user.emailaddress1;

                var mobilePhone = document.createElement("td");
                mobilePhone.textContent = user.mobilephone;

                var nfcCounterCell = document.createElement("tb");
                nfcCounterCell.textContent = user.izx_nfccounter;

                var tagIdCell = document.createElement("td");
                var tagIdButton = document.createElement("button");
                tagIdButton.textContent = "Show";
                tagIdButton.addEventListener("click", function () {
                    showTagIdData(user.izx_tagid); // Call function to show data user.izx_tagid
                });
                tagIdCell.appendChild(tagIdButton);

                row.appendChild(tagId);
                row.appendChild(nameCell);
                row.appendChild(emailCell);
                row.appendChild(mobilePhone);
                row.appendChild(nfcCounterCell);
                row.appendChild(tagIdCell);
                usersTableBody.appendChild(row);
            });
            usersTable.style.display = 'table';
            getUsersButton.disabled = false;
            message.textContent = '';
        }

        function showTagIdData(tagId) {
            debugger;
            authContext.acquireToken(organizationURI, function (error, token) {
                if (error || !token) {
                    console.error("Token error:", error);
                    errorMessage.textContent = 'ADAL error occurred: ' + error;
                    return;
                }

                var req = new XMLHttpRequest();
                // Ensure proper concatenation of $select and $filter
                var filterQuery = `$filter=izx_tagid eq '${tagId}'`;
                var selectQuery = `$select=izx_tagid,izx_timein,izx_timeout,izx_duration,izx_in_out,izx_timestamp`;
                var apiUrl = encodeURI(organizationURI + "/api/data/v9.2/izx_nfctrackings?" + selectQuery + "&" + filterQuery);
                req.open("GET", apiUrl, true);
                req.setRequestHeader("Authorization", "Bearer " + token);
                req.setRequestHeader("Accept", "application/json");
                req.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                req.setRequestHeader("OData-MaxVersion", "4.0");
                req.setRequestHeader("OData-Version", "4.0");

                req.onreadystatechange = function () {
                    if (this.readyState === 4) {
                        req.onreadystatechange = null;
                        if (this.status === 200) {
                            var tagDetails = JSON.parse(this.response).value;

                            // Check if records were returned for the tagId
                            if (tagDetails.length > 0) {
                                // Clear any existing rows in the modal table
                                var modalTableBody = document.getElementById("modalTagDetailsTableBody");
                                modalTableBody.innerHTML = "";

                                // Loop through each record and append it to the modal table
                                tagDetails.forEach(function (record) {
                                    var row = document.createElement("tr");

                                    // Helper function to format date (YYYY-MM-DD)
                                    function formatDate(dateString) {
                                        // Check if dateString is valid
                                        if (!dateString) {
                                            return 'N/A';
                                        }

                                        var date = new Date(dateString);
                                        // Check if the date is valid
                                        if (isNaN(date.getTime())) {
                                            return 'Invalid Date';
                                        }
                                        return date.toISOString().split('T')[0]; // Returns 'YYYY-MM-DD'
                                    }

                                    // Helper function to format time (HH:MM:SS)
                                    function formatTime(dateString) {
                                        // Check if dateString is valid
                                        if (!dateString) {
                                            return 'N/A';
                                        }

                                        var date = new Date(dateString);
                                        // Check if the date is valid
                                        if (isNaN(date.getTime())) {
                                            return 'Invalid Time';
                                        }
                                        return date.toISOString().split('T')[1].split('Z')[0]; // Returns 'HH:MM:SS'
                                    }

                                    // Create and append table cells for each field
                                    var tagIdCell = document.createElement("td");
                                    tagIdCell.textContent = record.izx_tagid || 'N/A';
                                    row.appendChild(tagIdCell);

                                    var timestampCell = document.createElement("td");
                                    timestampCell.textContent = formatDate(record.izx_timestamp) || 'N/A';
                                    row.appendChild(timestampCell);

                                    var timeInCell = document.createElement("td");
                                    timeInCell.textContent = formatTime(record.izx_timein) || 'N/A';
                                    row.appendChild(timeInCell);

                                    var timeOut = document.createElement("td");
                                    timeOut.textContent = formatTime(record.izx_timeout) || 'N/A';
                                    row.appendChild(timeOut);

                                    var durationCell = document.createElement("td");
                                    durationCell.textContent = record.izx_duration || 'N/A';
                                    row.appendChild(durationCell);

                                    var inOutCell = document.createElement("td");
                                    inOutCell.textContent = record.izx_in_out || 'N/A';
                                    row.appendChild(inOutCell);

                                    // Append the row to the modal table body
                                    modalTableBody.appendChild(row);
                                });

                                // Open the modal to display the data
                                var modal = document.getElementById("tagDetailsModal");
                                modal.style.display = "block";

                            } else {
                                alert("No records found for the provided tag ID.");
                                //console.error("No records found for the provided tag ID.");
                                //errorMessage.textContent = 'No records found for the provided tag ID.';
                            }
                        } else {
                            var error = JSON.parse(this.response).error;
                            console.error("Error retrieving tag details:", error.message);
                            errorMessage.textContent = error.message;
                        }
                    }
                };
                req.send();
            });
        }

        // When the user clicks on the close button, close the modal
        var closeModal = document.querySelector(".close");
        closeModal.onclick = function () {
            var modal = document.getElementById("tagDetailsModal");
            modal.style.display = "none";
        };

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            var modal = document.getElementById("tagDetailsModal");
            if (event.target === modal) {
                modal.style.display = "none";
            }
        };


        // Existing NFC Tracking Data code goes here
        var user, authContext, message, errorMessage, loginButton, logoutButton, getNFCTrackingDataButton, searchBar, nfctrackingsTable, nfctrackingsTableBody;

        var endpoints = { orgUri: organizationURI };

        window.config = {
            tenant: tenant,
            clientId: clientId,
            postLogoutRedirectUri: pageUrl,
            endpoints: endpoints,
            cacheLocation: 'localStorage',
        };

        function toggleLoggedInState(isLoggedIn) {
            if (isLoggedIn) {
                loginButton.classList.add("hidden");
                logoutButton.classList.remove("hidden");
                getNFCTrackingDataButton.style.display = "block";
                searchBar.style.display = "block";
            } else {
                loginButton.classList.remove("hidden");
                logoutButton.classList.add("hidden");
                getNFCTrackingDataButton.style.display = "none";
                searchBar.style.display = "none";
                nfctrackingsTable.classList.add("hidden");
            }
        }

        function login() {
            authContext.login();
        }

        function logout() {
            authContext.logOut();
            nfctrackingsTableBody.innerHTML = "";
            nfctrackingsTable.style.display = "none";
            toggleLoggedInState(false);
        }

        function getNFCTrackingData() {
            getNFCTrackingDataButton.disabled = false;
            message.textContent = "Retrieving NFC tracking data...";
            authContext.acquireToken(organizationURI, retrieveNFCTrackingData);
        }

        function retrieveNFCTrackingData(error, token) {
            if (error || !token) {
                errorMessage.textContent = 'ADAL error occurred: ' + error;
                return;
            }

            var req = new XMLHttpRequest();
            req.open("GET", encodeURI(organizationURI + "/api/data/v9.2/izx_nfctrackings?$select=izx_name,izx_tagid,izx_status,izx_timestamp,izx_timein,izx_timeout,izx_duration,izx_in_out"), true);
            req.setRequestHeader("Authorization", "Bearer " + token);
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Content-Type", "application/json; charset=utf-8");

            req.onreadystatechange = function () {
                if (this.readyState === 4) {
                    if (this.status === 200) {
                        var nfctrackings = JSON.parse(this.response).value;
                        renderNFCTrackingData(nfctrackings);
                    } else {
                        errorMessage.textContent = JSON.parse(this.response).error.message;
                    }
                }
            };
            req.send();
        }

        // Helper function to format date (YYYY-MM-DD)
        function formatDate(dateString) {
            var date = new Date(dateString);
            return date.toISOString().split('T')[0]; // Returns 'YYYY-MM-DD'
        }

        // Helper function to format time (HH:MM:SS)
        function formatTime(dateString) {
            var date = new Date(dateString);
            return date.toISOString().split('T')[1].split('Z')[0]; // Returns 'HH:MM:SS'
        }

        function renderNFCTrackingData(nfctrackings) {
            nfctrackingsTableBody.innerHTML = "";
            nfctrackings.forEach(function (tracking) {
                var row = document.createElement("tr");

                var nameCell = document.createElement("td");
                nameCell.textContent = tracking.izx_name;

                var tagIdCell = document.createElement("td");
                tagIdCell.textContent = tracking.izx_tagid;
                tagIdCell.classList.add("tag-id");

                var timestampCell = document.createElement("td");
                timestampCell.textContent = formatDate(tracking.izx_timestamp);

                var timeInCell = document.createElement("td");
                timeInCell.textContent = formatTime(tracking.izx_timein);

                var timeOutCell = document.createElement("td");
                timeOutCell.textContent = formatTime(tracking.izx_timeout);

                var durationCell = document.createElement("td");
                durationCell.textContent = tracking.izx_duration;

                var inoutCell = document.createElement("td");
                inoutCell.textContent = tracking.izx_in_out;

                row.appendChild(nameCell);
                row.appendChild(tagIdCell);
                row.appendChild(timestampCell);
                row.appendChild(timeInCell);
                row.appendChild(timeOutCell);
                row.appendChild(durationCell);
                row.appendChild(inoutCell);

                nfctrackingsTableBody.appendChild(row);
            });

            message.textContent = "NFC tracking data loaded successfully.";
            nfctrackingsTable.classList.remove("hidden");
        }

        function searchByTagID() {
            var filterValue = searchBar.value.toUpperCase();
            var rows = nfctrackingsTableBody.getElementsByTagName("tr");

            for (var i = 0; i < rows.length; i++) {
                var tagIdCell = rows[i].getElementsByClassName("tag-id")[0];
                if (tagIdCell) {
                    var tagId = tagIdCell.textContent.toUpperCase();
                    rows[i].style.display = tagId.indexOf(filterValue) > -1 ? "" : "none";
                }
            }
        }
    </script>

</body>
    </html>
